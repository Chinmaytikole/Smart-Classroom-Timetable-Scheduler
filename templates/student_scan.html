<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan QR + Face - Student Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    {% extends 'base.html' %}

    {% block content %}
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Scan QR + Face Verification</h4>
                    </div>
                    <div class="card-body">
                        <!-- Camera Stream Section -->
                        <div id="camera-section">
                            <h5>Step 1: Show QR Code to Camera</h5>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Position the QR code clearly in front of the camera. The system will automatically detect it.
                            </div>
                            <div class="text-center mb-3">
                                <img id="video-stream" src="{{ url_for('video_feed') }}" 
                                     width="640" height="480" alt="Camera Feed" 
                                     style="border: 2px solid #dee2e6; border-radius: 8px;">
                            </div>
                            
                            <div class="text-center mb-3">
                                <button id="scan-qr-btn" class="btn btn-success btn-lg">
                                    <i class="fas fa-qrcode me-2"></i>Capture QR Code
                                </button>
                                <button id="start-camera-btn" class="btn btn-outline-primary btn-lg">
                                    <i class="fas fa-camera me-2"></i>Start Camera
                                </button>
                                <button id="stop-camera-btn" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-stop me-2"></i>Stop Camera
                                </button>
                            </div>
                            
                            <div id="qr-status" class="text-center mb-3">
                                <span id="qr-indicator" class="badge bg-secondary fs-6">
                                    <i class="fas fa-search me-1"></i>Looking for QR Code...
                                </span>
                            </div>
                            
                            <div id="qr-result" class="mt-3"></div>
                        </div>

                        <!-- Face Verification Section -->
                        <div id="face-section" style="display: none;">
                            <h5 class="mt-4">Step 2: Face Verification</h5>
                            <div id="session-info" class="alert alert-info mb-3"></div>
                            
                            <div class="text-center">
                                <img id="face-stream" src="{{ url_for('video_feed') }}" 
                                     width="400" height="300" alt="Face Verification" 
                                     style="border: 2px solid #dee2e6; border-radius: 8px;">
                            </div>
                            
                            <div class="text-center mt-3">
                                <button id="capture-face-btn" class="btn btn-success btn-lg">
                                    <i class="fas fa-user-check me-2"></i>Verify Face & Mark Attendance
                                </button>
                            </div>
                            
                            <div id="verification-result" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    <script>
    let currentQrData = null;
    let isCameraActive = false;
    let qrCheckInterval = null;

    // Camera Control Functions
    document.getElementById('start-camera-btn').addEventListener('click', function() {
        startCamera();
    });

    document.getElementById('stop-camera-btn').addEventListener('click', function() {
        stopCamera();
    });

    document.getElementById('scan-qr-btn').addEventListener('click', function() {
        scanQRCode();
    });

    document.getElementById('capture-face-btn').addEventListener('click', function() {
        captureFaceForVerification();
    });

    async function startCamera() {
        try {
            const response = await fetch('/start_camera');
            const data = await response.json();
            
            if (data.success) {
                isCameraActive = true;
                document.getElementById('video-stream').src = "{{ url_for('video_feed') }}?t=" + new Date().getTime();
                document.getElementById('face-stream').src = "{{ url_for('video_feed') }}?t=" + new Date().getTime();
                showAlert('Camera started successfully!', 'success');
                
                // Start continuous QR checking
                startQRDetection();
            } else {
                showAlert('Failed to start camera: ' + data.message, 'danger');
            }
        } catch (error) {
            console.error('Error starting camera:', error);
            showAlert('Error starting camera: ' + error.message, 'danger');
        }
    }

    async function stopCamera() {
        try {
            const response = await fetch('/stop_camera');
            const data = await response.json();
            
            if (data.success) {
                isCameraActive = false;
                document.getElementById('video-stream').src = '';
                document.getElementById('face-stream').src = '';
                showAlert('Camera stopped successfully!', 'success');
                
                // Stop QR detection
                stopQRDetection();
            }
        } catch (error) {
            console.error('Error stopping camera:', error);
        }
    }

    function startQRDetection() {
        // Update status indicator
        document.getElementById('qr-indicator').innerHTML = '<i class="fas fa-search me-1"></i>Looking for QR Code...';
        document.getElementById('qr-indicator').className = 'badge bg-warning fs-6';
        
        // Check for QR codes every second
        qrCheckInterval = setInterval(checkForQRCode, 1000);
    }

    function stopQRDetection() {
        if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
            qrCheckInterval = null;
        }
        
        document.getElementById('qr-indicator').innerHTML = '<i class="fas fa-pause me-1"></i>Detection Stopped';
        document.getElementById('qr-indicator').className = 'badge bg-secondary fs-6';
    }

    async function checkForQRCode() {
        if (!isCameraActive) return;
        
        try {
            const response = await fetch('/capture_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success && data.qr_detected) {
                // Update indicator to show QR detected
                document.getElementById('qr-indicator').innerHTML = '<i class="fas fa-check-circle me-1"></i>QR Code Detected!';
                document.getElementById('qr-indicator').className = 'badge bg-success fs-6';
                
                // Stop continuous detection
                stopQRDetection();
                
                // Auto-process the QR code
                await processDetectedQR(data);
            } else {
                // Update indicator for searching
                document.getElementById('qr-indicator').innerHTML = '<i class="fas fa-search me-1"></i>Looking for QR Code...';
                document.getElementById('qr-indicator').className = 'badge bg-warning fs-6';
            }

        } catch (error) {
            console.error('QR checking error:', error);
        }
    }

    async function processDetectedQR(data) {
        const resultDiv = document.getElementById('qr-result');
        
        // Check for expired QR code
        if (data.expired) {
            resultDiv.innerHTML = '<div class="alert alert-warning">QR code has expired. Please ask your faculty for a new one.</div>';
            // Restart detection after 3 seconds
            setTimeout(startQRDetection, 3000);
            return;
        }
        
        // Check for invalid format
        if (data.invalid_format) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Invalid QR code format. Please use a valid attendance QR code.</div>';
            // Restart detection after 3 seconds
            setTimeout(startQRDetection, 3000);
            return;
        }
        
        // Valid QR code detected
        resultDiv.innerHTML = '<div class="alert alert-success">QR Code validated! Proceed to face verification.</div>';
        currentQrData = data.qr_data;

        // Show session info
        document.getElementById('session-info').innerHTML = 
            `Subject: <strong>${data.qr_data.subject_id}</strong> | Batch: <strong>${data.qr_data.batch_id}</strong>`;

        // Show face verification section
        document.getElementById('camera-section').style.display = 'none';
        document.getElementById('face-section').style.display = 'block';
    }

    async function scanQRCode() {
        if (!isCameraActive) {
            showAlert('Please start the camera first.', 'warning');
            return;
        }

        const scanBtn = document.getElementById('scan-qr-btn');
        const resultDiv = document.getElementById('qr-result');
        
        scanBtn.disabled = true;
        scanBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Capturing...';
        resultDiv.innerHTML = '<div class="alert alert-info">Capturing QR code from current frame...</div>';

        try {
            const response = await fetch('/capture_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (data.success && data.qr_detected) {
                await processDetectedQR(data);
            } else {
                resultDiv.innerHTML = '<div class="alert alert-warning">No QR code detected in current frame. Please ensure the QR code is clearly visible and try again.</div>';
            }

        } catch (error) {
            console.error('QR scanning error:', error);
            resultDiv.innerHTML = '<div class="alert alert-danger">Error scanning QR code. Please try again.</div>';
        } finally {
            scanBtn.disabled = false;
            scanBtn.innerHTML = '<i class="fas fa-qrcode me-2"></i>Capture QR Code';
        }
    }

    async function captureFaceForVerification() {
        if (!isCameraActive) {
            showAlert('Camera is not active. Please start the camera first.', 'warning');
            return;
        }

        const captureBtn = document.getElementById('capture-face-btn');
        const resultDiv = document.getElementById('verification-result');
        
        captureBtn.disabled = true;
        captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...';
        resultDiv.innerHTML = '<div class="alert alert-info">Capturing face image and verifying... Please look directly at the camera.</div>';

        try {
            // Capture frame for face verification
            const response = await fetch('/capture_face_verification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    qr_data: currentQrData,
                    student_id: '{{ session.get("student_id") }}'
                })
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>Attendance Marked Successfully!</h5>
                        <p>${data.message}</p>
                        <p><strong>Subject:</strong> ${data.subject_name}</p>
                        <p><strong>Batch:</strong> ${data.batch_name}</p>
                        <p><strong>Time:</strong> ${data.attendance_time}</p>
                        <p><strong>Face Confidence:</strong> ${data.confidence_score}%</p>
                    </div>
                `;

                // Stop camera after successful verification
                await stopCamera();

                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = "{{ url_for('student_dashboard') }}";
                }, 3000);

            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                captureBtn.disabled = false;
                captureBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>Try Again';
            }

        } catch (error) {
            console.error('Face verification error:', error);
            resultDiv.innerHTML = `<div class="alert alert-danger">Error during face verification: ${error.message}</div>`;
            captureBtn.disabled = false;
            captureBtn.innerHTML = '<i class="fas fa-user-check me-2"></i>Try Again';
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.card-body').prepend(alertDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Clean up when leaving page
    window.addEventListener('beforeunload', function() {
        if (isCameraActive) {
            fetch('/stop_camera').catch(console.error);
        }
        if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
        }
    });

    // Initialize camera on page load
    document.addEventListener('DOMContentLoaded', function() {
        startCamera();
    });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>