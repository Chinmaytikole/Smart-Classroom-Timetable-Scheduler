{% extends "base.html" %}

{% block title %}Faculty - Intelligent Timetable System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-users"></i> Faculty Management</h1>
    {% if session.role == 'admin' %}
    <div>
        <a href="{{ url_for('upload_csv') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-file-import"></i> Import CSV
        </a>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFacultyModal">
            <i class="fas fa-plus"></i> Add Faculty
        </button>
    </div>
    {% endif %}
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-list"></i> All Faculty Members</h5>
    </div>
    <div class="card-body">
        {% if faculty %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Subjects</th>
                        <th>Leaves/Month</th>
                        <th>Max Hours/Day</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fac in faculty %}
                    <tr>
                        <td class="fw-bold">{{ fac.employee_id }}</td>
                        <td>{{ fac.name }}</td>
                        <td>{{ fac.department_name or 'N/A' }}</td>
                        <td>
                            {% set faculty_subjects = get_faculty_subjects(fac.id) %}
                            {% if faculty_subjects %}
                                {% for subject in faculty_subjects[:3] %}
                                    <span class="badge bg-info mb-1">{{ subject.code }}</span>
                                {% endfor %}
                                {% if faculty_subjects|length > 3 %}
                                    <span class="badge bg-secondary">+{{ faculty_subjects|length - 3 }} more</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">No subjects</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ 'warning' if fac.avg_leaves_per_month and fac.avg_leaves_per_month > 2 else 'info' }}">
                                {{ fac.avg_leaves_per_month or 0 }} days
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ fac.max_hours_per_day }} hours</span>
                        </td>
                        <td>
                            <a href="{{ url_for('faculty_subjects', faculty_id=fac.id) }}" class="btn btn-sm btn-outline-info" title="Manage Subjects">
                                <i class="fas fa-book"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" 
                                    data-bs-target="#manageLeavesModal" 
                                    data-id="{{ fac.id }}"
                                    data-name="{{ fac.name }}"
                                    data-leaves="{{ fac.avg_leaves_per_month or 0 }}"
                                    title="Manage Leaves">
                                <i class="fas fa-calendar-minus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" 
                                    data-bs-target="#editFacultyModal" 
                                    data-id="{{ fac.id }}"
                                    data-name="{{ fac.name }}"
                                    data-empid="{{ fac.employee_id }}"
                                    data-dept="{{ fac.department_id }}"
                                    data-hours="{{ fac.max_hours_per_day }}"
                                    data-times="{{ fac.preferred_times }}"
                                    title="Edit Faculty">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" 
                                    data-bs-target="#deleteFacultyModal" 
                                    data-id="{{ fac.id }}"
                                    data-name="{{ fac.name }}"
                                    title="Delete Faculty">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No faculty members found. Add some faculty to get started.
        </div>
        {% endif %}
    </div>
</div>

<!-- Manage Leaves Modal -->
<div class="modal fade" id="manageLeavesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title"><i class="fas fa-calendar-minus"></i> Manage Faculty Leaves</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('update_faculty_leaves') }}">
                <input type="hidden" name="faculty_id" id="manageLeavesFacultyId">
                <div class="modal-body">
                    <p>Managing leaves for: <strong id="manageLeavesFacultyName"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Average Leaves Per Month</label>
                        <input type="number" class="form-control" name="avg_leaves_per_month" 
                               id="manageLeavesCount" min="0" max="10" step="0.5" required>
                        <div class="form-text">Average number of leave days taken per month (affects scheduling)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Update Leaves</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if session.role == 'admin' %}
    <!-- Add Faculty Modal -->
    <div class="modal fade" id="addFacultyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Faculty</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('add_faculty') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Employee ID</label>
                            <input type="text" class="form-control" name="employee_id" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department_id" required>
                                <option value="">Select Department</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Hours Per Day</label>
                            <input type="number" class="form-control" name="max_hours_per_day" value="8" min="1" max="12" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preferred Time Slots (comma-separated)</label>
                            <input type="text" class="form-control" name="preferred_times" placeholder="9:00-10:00, 10:00-11:00">
                            <div class="form-text">Leave blank for no preference</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Faculty</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Faculty Modal -->
    <div class="modal fade" id="editFacultyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Faculty</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_faculty') }}">
                    <input type="hidden" name="faculty_id" id="editFacultyId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Employee ID</label>
                            <input type="text" class="form-control" name="employee_id" id="editFacultyEmpId" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="name" id="editFacultyName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department</label>
                            <select class="form-select" name="department_id" id="editFacultyDept" required>
                                <option value="">Select Department</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Max Hours Per Day</label>
                            <input type="number" class="form-control" name="max_hours_per_day" id="editFacultyHours" min="1" max="12" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preferred Time Slots (comma-separated)</label>
                            <input type="text" class="form-control" name="preferred_times" id="editFacultyTimes">
                            <div class="form-text">Leave blank for no preference</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Faculty</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Faculty Modal -->
    <div class="modal fade" id="deleteFacultyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-trash"></i> Delete Faculty</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('delete_faculty') }}">
                    <input type="hidden" name="faculty_id" id="deleteFacultyId">
                    <div class="modal-body">
                        <p>Are you sure you want to delete faculty member <strong id="deleteFacultyName"></strong>?</p>
                        <p class="text-danger">This action cannot be undone and may affect existing timetables.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete Faculty</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}
{% block scripts %}
<script>
// Edit faculty modal handler
document.getElementById('editFacultyModal').addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    document.getElementById('editFacultyId').value = button.getAttribute('data-id');
    document.getElementById('editFacultyEmpId').value = button.getAttribute('data-empid');
    document.getElementById('editFacultyName').value = button.getAttribute('data-name');
    document.getElementById('editFacultyDept').value = button.getAttribute('data-dept');
    document.getElementById('editFacultyHours').value = button.getAttribute('data-hours');
    document.getElementById('editFacultyTimes').value = button.getAttribute('data-times');
});

// Delete faculty modal handler
document.getElementById('deleteFacultyModal').addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    document.getElementById('deleteFacultyId').value = button.getAttribute('data-id');
    document.getElementById('deleteFacultyName').textContent = button.getAttribute('data-name');
});

// Manage leaves modal handler
document.getElementById('manageLeavesModal').addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    document.getElementById('manageLeavesFacultyId').value = button.getAttribute('data-id');
    document.getElementById('manageLeavesFacultyName').textContent = button.getAttribute('data-name');
    document.getElementById('manageLeavesCount').value = button.getAttribute('data-leaves');
});
</script>
{% endblock %}

